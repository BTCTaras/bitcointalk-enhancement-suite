(function() {	
	// The arrays below are as of 7/21/2017
	// May add auto-updating lists in the future...

	// All users with DefaultTrust depth 1
	var defaulttrust1 = ["theymos","HostFat","dooglus","Maged","dserrano5","OgNasty","Tomatocage","SaltySpitoon","DeaDTerra","philipma1957","Cyrus","Blazed","hilariousandco","OldScammerTag"];

	// All users with DefaultTrust depth 2
	var defaulttrust1 = ["HostFat","mikegogulski","Light","dooglus","Raize","Maged","gmaxwell","Carnth","TECSHARE","Caesium","phantastisch","OgNasty","zvs","-ck","malevolent","Matthew N. Wright","Korbman","paraipan","John","","danieldaniel","maxmint","dree12","Tomatocage","SaltySpitoon","ineededausername","DeaDTerra","BadBear","El Cabron","Blazr","xkrikl","BCB","DiamondCardz","Xian01","btharper","burnside","LoweryCBS","lophie","stenkross","Benson Samuel","TradeFortress","shiftybugger","uhnonamiss","Cyrus","nubbins","ThickAsThieves","fluidjax","ibminer","Wardrick","byt411","Boelens","BigBitz","binaryFate","markj113","TomUnderSea","rarkenin","dwdoc","blackarrow","spartan82","idee2013","Tywill","sayulita","DefaultTrust","Taras","favdesu","nachius","marcotheminer","LazerViking","hilariousandco","MadZ","shorena","artw1982","mitzie","Jaaawsh","LYCAN","Spodermen","sirius","theymos","Gavin Andresen","rb1205","paci","CanaryInTheMine","Stemby","ziomik","Vod","ercolinux","diego1000","kelpy","GIANNAT","bertani","Cripto","Lauda","gdassori","ghibly79","brutale2","Anon39","davvo","alch1mista","casascius","Stunna","master-P","Xialla","NLNico","BayAreaCoins","cryptodevil","suchmoon","ThePhwner","Quickseller","RHavar","tysat","piuk","sveetsnelda","dogie","OldScammerTag","nanotube","grue","Kluge","teukon","majamalu","jackjack","yxt","aigeezer","DeathAndTaxes","Shawshank","vgo","Dabs","DannyHamilton","LuisCar","fernarios","ioxoi","gentlemand","EcuaMobi","naypalm","Bees Brothers","nonnakip","TMAN","Zepher","Lutpin","EPiSKiNG","piotr_n","Mousepotato","jwzguy","dserrano5","haploid23","the joint","smoothie","Michail1","wallet.dat","philipma1957","KWH","guitarplinker","xetsr","pr0d1gy","Timelord2067","Blazed","kashish948","Powell","shdvb","argovian","Gleb Gamow","MCHouston","gate11","Tomatocage1","Ryland R. Taylor-Almanza","Mushroomized","johnniewalker","Stefan Thomas","bitdragon","ADgordo","will","Sukrim","evoorhees","Isepick","NielDLR","kjj","adrd","tulkos","CecilNiosaki","Lord F(r)og","GoWest","burger","usagi","Mushoz","Koekiemonster","Timbo925","Winterfrost","Xenophon","Choroid Plexus","strello","demcoins","Ago_Solvo","tolan77","VJain","davos","Vezunchik","rottenchris","btclvr","tyrion70","Jgguy","ks1","CrazyGuy","Unacceptable","kano","Cablez","davecoin","TheButterZone","iluvpcs","crashoveride54902","lazlopanaflex","buysolar","TookDk","Chris_Sabian","Stratobitz","MoreBloodWine","pcfli","edonkey","wlefever","generalt","nicehash","Mikestang","MiningBuddy","escrow.ms","Welsh","rammy2k2","Mitchell","EAL","Stephen Gornick","SebastianJu","qwk","Todamont","Justin00","monbux","devthedev","bitmarket.io","hedgy73","mexxer-2","minerjones","yahoo62278"];
	
	// All users with legacy scammer tags
	var scammertags = ["dank","Nefario","Clipse","cablepair","PatrickHarnett","shakaru","chungenhung","bitlotto","pirateat40","ianbakewell","BTC guy","Aahzman","amazingrando","kr4x","FooDSt4mP","hashking","limitless","vdragon","R-","nckrazze","demonofelru","saudibull","Andrew Bitcoiner","Sjalq","Bind","Hollie","cryptoxchange","killer2021","newdude","TizzyTazzy","Snapman","Joshster","joeyjmr8484","AlternativeCypt","SHlFT","Stefanie Andrea","DoubleIcaras","wildemagic","lolcat","constitution","NINJA--","snedie","bitdaytrade","bitscalper","mu50stang","yacoin","jetset220","Leon","kingkatari","MartinReynolds","slammed","Juneteenth","Jermain√©","brunoshady","Breen2543","Zem","SynOps","carebear","iamtheone","RyanWebber","gurg2.o","Bush","wong RAP","bayer","Icy-","pippipcheerio","HonorMe","kujoking7","epiks","mining4fun11","penetration","Bitcraft","laydum","mexxer","bombshelterzero","cardinalG","furrycoat","Gluskab","ThyDude","Clarithium","Xanax","SouthernComfort","borito4","Black_Star","RustyRyan","btcmank","Zombie","Globes","sylkyx","kidage","john_nalpa","Amanda","lxFlasHxl","Anonymouss","tmac667","loadrs2009","dareq","rothglobal","quartz92","Alwaysmining","Si Robertson","on9isrock","AaronBreillat","unkn0wn12","FocusMedia","illWill","TheLastDovah","DiamondPlus","Exo","caradenada","Intueri","AndrewJ","Pearikay","darvil","mini_lol","bitcoinhero","JCbit","MaxPumper","LionHeart","Bitzing","OMGBobMarley","ex0420","thebitbabe","Jimmysmith","tachi641","anonameous","CouragedOne","madload",".ME","HaRRo","siesatsu","TORwallet","turquoise9955","BTC4PPGBP","PPoweredP","Ryuguy","ChickaDee",".","Bitexchange","DrZaius","AreYouCereal","firstlady0524","mixmastermine","Meddol","bcjunkie","Julia Sanders","NoValues","etsanchez","Dakster","arobinson","dayasinfo","Alexsandr","boogiedown","MiddleMan","rodneycubed","BitCoinBoom","MikeT","MouseTrap","Randy","CNClove","Gabriellz9","boatedaces","008","satosamoto","foofight","Kz3ro","InterCoin","wjohnnyw","PayPal","vincentio","TigerGuy007","Lieutenant Dan","Powercoiner","moneypak","FastCoin","Diamond","CeltixBos","Raeldi","Aldun","btclaw","BTCMover","MoneypakBuyer","endercoin","happyworld3000","sellbitcoins","partyjumpyup","Tucker","Riddleman","zionist shill","moomerycreamery","ndawg4554","nckfor","daywalker","Linux","min0r","btcace","Oracle24","AshShep","thegogos","Darknesss","SellBitcoinsTo","crzr","CrowdCrackingGroup","diegospensi7","Lavada","hilarioprnce7","errtest","trusturtechnolust","Lang","bitcento","kellyhuta64","lolbillfrist","pooraich","jimmi12","iamstimpy","uAbbieBartonq","azerty6757","Miss_Magenta","emoryyrer96","Bitcoinmaker","pandapeluche","matthewdowns1128A1F5","conradinoz76","bitboy999","rockstarshorty21","cspalmer2","chevo","headhunter","KatiHahnA","sarajasie0C2C","bryankfurw05","brigitte2378sack","xerces","edwinaphan7","MSTRKRFT","williamsnider72","Sandragutierre24Y","jeraldftizt65","joan48ellis","cocopuffs1003","colliefan1","DigiZ","TheRonPaulKid","stevguthie7","fiveletterword","Exclusive","lfelicols12t","SusanaMenor23","ymfeeling","Robert William Bonzi","balmut051","carsonchassy5","UnKnOwNiSh","BTCPlay","terrence","IllBill","milardistone41","Lubaday","krypton85","susanakaul","iPhone.5","leahsandes","MellisaAnn","westcoastconnect","jjfarren","GammaRayCoin","millermint","BitcoinSolutions","ElectricBTC","Maddhatter","ScoobieDoo","SwimsuitPaul","cbuchnner1","Hellaphunt","John (John K) IMPERSONATOR","thecanadian420","cotoro","Zyzz","Randal112","fake_gwillen","Robert Fienstien","mikel123","Skyliner","RushBit","mgmtlol","HiddenTesoro","Z3R00","BitcoinSmarket","Maldun","SpeedGold","ExclusiveBTC","Plateen","BitcoinDoubleSpender","Elderal"];
	
	// Loop through sidebars of posts to apply changes to them
	document.querySelectorAll(".poster_info").forEach(function(sidebar) {
		var user = sidebar.getElementsByTagName("b")[0].getElementsByTagName("a")[0].innerHTML;
		
		// Check if the user is a newbie (not jr. member!)
		var rank = sidebar.getElementsByTagName("div")[0].innerHTML.substr(0,15)
		if (rank.includes("Brand new") || rank.includes("Newbie")) {
			// Delete the newbie's one gold coin (they'll only have one if they are a newbie)
			sidebar.getElementsByTagName("img")[0].parentNode.removeChild(sidebar.getElementsByTagName("img")[0]);
			
			// Insert a silver coin as a replacement
			sidebar.getElementsByTagName("br")[0].insertAdjacentHTML("afterend", "<img src=\""+chrome.extension.getURL("images/newbie.png")+"\" alt=\"*\" border=\"0\">");
		}
		
		// Check if we should apply a legacy scammer tag
		if (scammertags.includes(user)) {
			// Put in the old "SCAMMER" title where it used to be
			sidebar.getElementsByTagName("div")[0].insertAdjacentHTML("afterbegin", "SCAMMER<br/>");
			
			// Remove the coin pips underneath the scammer's name
			for (var attempt = 0; attempt < 3; attempt++) { // Make 3 attempts (not all the pips are deleted on the first try for full and hero members for some reason)
				var icons = sidebar.getElementsByTagName("img");
				for (var i = 0; i < icons.length; i++)
					if (icons.item(i).className != "avatar") // Don't remove the avatar!
						icons.item(i).parentNode.removeChild(icons.item(i));
			}
			
			// Insert the scammer tag image (the five red X's)
			for (var i = 0; i < 5; i++)
				sidebar.getElementsByTagName("br")[1].insertAdjacentHTML("afterend", "<img src=\""+chrome.extension.getURL("images/scammer.gif")+"\" alt=\"X\" border=\"0\">");
		}
	});
	
	// Delete the button to insert a flash video from the post editor - the feature is completely disabled on BitcoinTalk and therefore useless
	document.querySelectorAll("[onclick=\"surroundText('[flash=200,200]', '[/flash]', document.forms.postmodify.message); return false;\"]").forEach(function(btn) {
		btn.parentNode.removeChild(btn);
	});
	
	// Select the text box for the post editor
	document.querySelectorAll(".editor").forEach(function(editor) {
		// Make a character counter above the textarea
		editor.insertAdjacentHTML("beforebegin","<div style=\"width: 600px; max-width: 600px;\">Character count: <b id=\"btes_charcount\"></b> <span style=\"display: none;\" id=\"btes_warning\">(This post has exceeded BitcoinTalk's post size limit of 64000 characters!)</span></div>");
		
		// Update the counter every second
		window.setInterval(function(){
			var raw = document.querySelector(".editor").value;
			var content = raw;
			
			// Don't count these characters as constructive
			content = content.replace("\n","");
			content = content.replace("\r","");
			content = content.replace("\t","");
			
			// Don't count quoted text as original
			content = content.replace(/\[quote[\s\S]*?\/quote\]/gi, "");
			
			// Images shouldn't be considered as text
			content = content.replace(/\[img[\s\S]*?\/img\]/gi, "");
			
			// Bitcoin symbols count as a single character
			content = content.replace("[btc]", "B");
			
			// Tags themselves shouldn't be considered to be content
			content = content.replace(/\[[\s\S]*?\]/gi, "");
			
			var count = content.trim().length;
			
			// Achow's BitcoinTalk Account Price Estimator and many signature campaigns consider posts with fewer than 75 characters to be bad
			if (count < 75)
				document.getElementById("btes_charcount").setAttribute("style", "color: #DC143C;"); // red
			else if (count >= 100) // You should strive for 100+!
				document.getElementById("btes_charcount").setAttribute("style", "color: #008000;"); // green
			else
				document.getElementById("btes_charcount").setAttribute("style", "color: black;");
			
			// If the raw post length is greater than 64000 characters, it is unacceptable and will be rejected, so let the user know
			if (raw.length > 64000) {
				document.getElementById("btes_warning").setAttribute("style", "color: red;");
			} else {
				document.getElementById("btes_warning").setAttribute("style", "display: none;");
			}
			
			// Display the number of characters that are original and "constructive"
			document.getElementById("btes_charcount").innerHTML = count;
		}, 1000);
	});
	
	// On the showposts page, if a post has a code block with a very long unbroken line, the table of posts will be distorted and very hard to read.
	/* This will fix that by limiting how wide code blocks can be drawn
	document.querySelectorAll(".titlebg").forEach(function(testForPostList) {
		// Determine if this page is a list of a user's posts
		if (testForPostList.getElementsByTagName("td")[0].innerHTML.includes("Show Posts")) {
			// Find all code blocks on the page
			document.querySelectorAll(".code").forEach(function(codeblock) {
				// and make them no wider than 800 pixels
				codeblock.setAttribute("style", "max-width: 800px;");
			});
		}
	});*/
	
	// 
	document.querySelectorAll(".maintab_active_back").forEach(function(maintab) {
		// Locate the MY MESSAGES tab
		var inboxlink = maintab.parentNode.getElementsByTagName("td")[8].getElementsByTagName("a")[0];
		// Check if there is any new mail
		if (inboxlink.innerHTML.includes("[")) {
			var messages = inboxlink.getElementsByTagName("strong")[0].innerHTML;
			if (!messages.includes("["))
				inboxlink.innerHTML = "MY MESSAGES <strong style='background: red; padding-right: 1px;'>["+messages+"]</strong>";
		}
	});
	
	var optionslink = "";
	document.querySelectorAll("a").forEach(function(lnk) {
		if (lnk.innerHTML == "Look and Layout Preferences") {
			optionslink = lnk.getAttribute("href") + ";btes";
		}
		if (optionslink.length > 0)
			if (lnk.innerHTML == "Ignore Boards Preferences")
				lnk.insertAdjacentHTML("afterend", "<br/><a href=\""+optionslink+"\" style=\"color: orange;\">BitcoinTalk Enhancement Suite Options</a>");
	});
	
	if (window.location.href.substr(-5,5) == ";btes") {
		document.querySelectorAll("#creator").forEach(function(settingspanel) {
			settingspanel.innerHTML = "<iframe src=\""+chrome.runtime.getURL("options/options.html")+"\" frameBorder=\"0\" width=\"100%\" style=\"min-height: 640px;\"></iframe>";
		});
		
		document.querySelectorAll("a").forEach(function(lnk) {
			if (lnk.innerHTML == "Look and Layout Preferences") {
				lnk.setAttribute("style", "font-weight: normal !important;");
			}
		});
		
		document.querySelectorAll("a").forEach(function(lnk) {
			if (lnk.innerHTML == "BitcoinTalk Enhancement Suite Options") {
				lnk.setAttribute("style", "color: orange; font-weight: bold !important;");
			}
		});
	}
})();